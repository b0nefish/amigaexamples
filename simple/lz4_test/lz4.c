#include <stdio.h>
#include <string.h>
#include "lz4_uncrunch.h"

/*
** Links to the LZ4 decompressor:
**
** * https://github.com/arnaud-carre/lz4-68k
** * https://github.com/lz4/lz4/blob/master/doc/lz4_Block_format.md
**
** Compressing a file using the lz4 command-line tool prepends a
** header of 11 bytes and appends 4 zero bytes, the so-called end
** mark, and four bytes with the frame CRC (if not turned of by using
** "--no-frame-crc".
*/


// the following can be generated using:
//
//	echo "â€¦" | lz4 -9 --no-frame-crc | xxd -i
static unsigned char array[] = {
  // Magic Bytes
  0x04, 0x22, 0x4d, 0x18,
  // Header
  0x60, 0x40, 0x82, 0x76, 0x00, 0x00, 0x00,
  // Data
  0xc7, 0x52, 0x65, 0x67, 0x65, 0x6e, 0x20, 0x72, 0x65, 0x67, 0x6e, 0x65,
  0x74, 0x07, 0x00, 0x4b, 0x65, 0x6e, 0x0a, 0x72, 0x1a, 0x00, 0xfa, 0x01,
  0x65, 0x6e, 0x20, 0x6e, 0x69, 0x63, 0x68, 0x74, 0x0a, 0x6e, 0x69, 0x65,
  0x6d, 0x61, 0x6c, 0x73, 0x1b, 0x00, 0x05, 0x34, 0x00, 0x06, 0x13, 0x00,
  0x71, 0x69, 0x6e, 0x73, 0x20, 0x67, 0x65, 0x73, 0x34, 0x00, 0x02, 0x4e,
  0x00, 0x81, 0x70, 0x66, 0x65, 0x69, 0x66, 0x65, 0x72, 0x20, 0x08, 0x00,
  0x53, 0x74, 0x20, 0x64, 0x65, 0x6d, 0x38, 0x00, 0x0c, 0x11, 0x00, 0x09,
  0x3c, 0x00, 0x6f, 0x77, 0x61, 0x72, 0x75, 0x6d, 0x20, 0x3c, 0x00, 0x06,
  0x62, 0x77, 0x69, 0x73, 0x73, 0x65, 0x6e, 0x18, 0x00, 0x45, 0x20, 0x75,
  0x6e, 0x64, 0xac, 0x00, 0x50, 0x63, 0x68, 0x74, 0x0a, 0x0a,
  // Footer aka file size (32 bit, if zero then end of blocks).
  0x00, 0x00, 0x00, 0x00
  /*
   * The above is the poen "Regengesicht" by Christa Reinig. See https://en.wikipedia.org/wiki/Christa_Reinig.
   */
};

static char buffer[4096];

int main(int argc, char **argv) {
  const int skip_header = 4 + 7;
  const int skip_footer = 4;

  printf("lz4_uncrunch=$%08lX\n", (unsigned long)&lz4_uncrunch);
  printf("buffer=$%08lX\n", (unsigned long)buffer);
  memset(buffer, 0, sizeof(buffer));
  puts("LZ4 decrunching data...");
  lz4_uncrunch(&array[skip_header],
	       buffer,
	       sizeof(array) - skip_header - skip_footer);
  printf("%s\n", buffer);
  return 0;
}
